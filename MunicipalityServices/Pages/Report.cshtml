@page
@model MunicipalityServices.Pages.ReportModel
@using Microsoft.AspNetCore.Http
@{
    ViewData["Title"] = "Report Issues";
    var isSignedIn = HttpContext.Session.GetString("SignedIn") == "true";
}
<div class="index-content">
    <h1 class="report-issues-heading">Report Issues</h1>

    @if (isSignedIn)
    {
        <div style="display: flex; gap: 40px; justify-content: flex-start; align-items: flex-start;">
            <!-- Report Form Block (left, bigger, more left) -->
            <div style="flex: 10.5; max-width: 950px; min-width: 520px; margin-left: 0;">
                <div id="form-progress-container" style="width:100%; margin-bottom:20px;">
                    <div id="form-progress-bar" style="height:18px; width:0; background:#e6b13a; border-radius:8px; transition:width 0.3s;"></div>
                </div>
                <form method="post" enctype="multipart/form-data" class="report-issues-form" id="issues-form">
                    <div asp-validation-summary="All" class="text-danger"></div>

                    <div class="report-issues-row">
                        <label asp-for="Location" class="report-label"></label>
                        <input asp-for="Location" class="report-input" />
                    </div>

                    <div class="report-issues-row">
                        <label asp-for="Category" class="report-label"></label>
                        <select asp-for="Category" asp-items="Model.Categories" class="report-input">
                            <option value="">-- Select category --</option>
                        </select>
                    </div>

                    <div class="report-issues-row">
                        <label asp-for="Description" class="report-label"></label>
                        <textarea asp-for="Description" rows="3" class="report-input"></textarea>
                    </div>

                    <div class="report-issues-row">
                        <label asp-for="Image" class="report-label"></label>
                        <input asp-for="Image" type="file" class="report-input" />
                    </div>

                    <button type="submit" class="report-submit-btn">Submit</button>
                </form>
            </div>

            <!-- Daily Community Pulse Block (right, smaller) -->
            <div class="report-issues-form" style="background: #fff; box-shadow: 0 0 0 6px #e6b13a; flex: 1; max-width: 340px; min-width: 260px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                <h2 class="report-issues-heading" style="background: #e6b13a; color: #417a4a; font-size: 1.5rem; margin-bottom: 18px;">Daily Community Pulse</h2>
                <form id="pulse-form" style="width: 100%;">
                    <div class="report-label" style="color: #417a4a; font-size: 1.1rem; margin-bottom: 16px;">
                        @Model.TodayPulseQuestion.Question
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 18px;">
                        @for (int i = 0; i < Model.TodayPulseQuestion.Answers.Length; i++)
                        {
                            <label>
                                <input type="radio" name="PulseAnswer" value="@Model.TodayPulseQuestion.Answers[i]" />
                                @Model.TodayPulseQuestion.Answers[i]
                            </label>
                        }
                    </div>
                    <button type="submit" class="report-submit-btn" style="background: #e6b13a; color: #417a4a; border: 3px solid #417a4a;">Submit</button>
                    <div id="pulse-thankyou" style="display:none; color:#417a4a; font-weight:600; margin-top:18px; text-align:center;">
                        Thank you for your input - you have earned 5 data-points !
                    </div>
                </form>
            </div>
        </div>
        <script>
            document.getElementById('pulse-form').addEventListener('submit', function (e) {
                e.preventDefault();
                document.getElementById('pulse-thankyou').style.display = 'block';

                // Set a cookie with today's date (UTC, for consistency)
                // var today = new Date();
                // var yyyyMMdd = today.getUTCFullYear() + '-' + (today.getUTCMonth()+1).toString().padStart(2, '0') + '-' + today.getUTCDate().toString().padStart(2, '0');
                // document.cookie = "PulseAnsweredDate=" + yyyyMMdd + "; path=/; expires=" + new Date(today.getTime() + 365*24*60*60*1000).toUTCString();
            });
        </script>
        @* <script>
            function getCookie(name) {
                let value = "; " + document.cookie;
                let parts = value.split("; " + name + "=");
                if (parts.length === 2) return parts.pop().split(";").shift();
            }

            window.addEventListener('DOMContentLoaded', function () {
                var today = new Date();
                var yyyyMMdd = today.getUTCFullYear() + '-' + (today.getUTCMonth()+1).toString().padStart(2, '0') + '-' + today.getUTCDate().toString().padStart(2, '0');
                var answeredDate = getCookie('PulseAnsweredDate');
                if (answeredDate === yyyyMMdd) {
                    // Hide the form, show thank you
                    document.getElementById('pulse-form').style.display = 'none';
                    document.getElementById('pulse-thankyou').style.display = 'block';
                }
            });
        </script> *@
    }
    else
    {
        <!-- Only the main report form, centered -->
        <div id="form-progress-container" style="width:100%; margin-bottom:20px;">
            <div id="form-progress-bar" style="height:18px; width:0; background:#e6b13a; border-radius:8px; transition:width 0.3s;"></div>
        </div>
        <form method="post" enctype="multipart/form-data" class="report-issues-form" id="issues-form">
            <div asp-validation-summary="All" class="text-danger"></div>

            <div class="report-issues-row">
                <label asp-for="Location" class="report-label"></label>
                <input asp-for="Location" class="report-input" />
            </div>

            <div class="report-issues-row">
                <label asp-for="Category" class="report-label"></label>
                <select asp-for="Category" asp-items="Model.Categories" class="report-input">
                    <option value="">-- Select category --</option>
                </select>
            </div>

            <div class="report-issues-row">
                <label asp-for="Description" class="report-label"></label>
                <textarea asp-for="Description" rows="3" class="report-input"></textarea>
            </div>

            <div class="report-issues-row">
                <label asp-for="Image" class="report-label"></label>
                <input asp-for="Image" type="file" class="report-input" />
            </div>

            <button type="submit" class="report-submit-btn">Submit</button>
        </form>
    }
</div>






